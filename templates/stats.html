{% extends "base.html" %}

{% block content %}
<style>
  body {
    background: radial-gradient(circle at top, #0b1224, #05070d 55%, #030407 100%);
    color: #e8e8e8;
  }
  .stats-wrapper {
    max-width: 980px;
    margin: 28px auto 60px;
    padding: 0 16px;
  }
  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0f162b;
    border: 1px solid rgba(255, 215, 130, 0.18);
    border-radius: 14px;
    padding: 14px 18px;
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
  }
  .btn-ghost {
    background: #0b1122;
    border: 1px solid #28314e;
    color: #cdd2e2;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 600;
  }
  .stats-header h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px;
    margin-top: 18px;
  }
  .stat-card {
    background: #0f162b;
    border: 1px solid rgba(255, 215, 130, 0.18);
    border-radius: 14px;
    padding: 16px;
    text-align: center;
  }
  .stat-card .label {
    font-size: 12px;
    color: #9aa2ba;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .stat-card .value {
    font-size: 24px;
    font-weight: 700;
    margin-top: 6px;
    color: #f0c061;
  }
  .stats-section {
    margin-top: 22px;
    background: #0f162b;
    border: 1px solid rgba(255, 215, 130, 0.18);
    border-radius: 14px;
    padding: 18px;
  }
  .progress-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  .rank-panel {
    margin-top: 12px;
    display: none;
    background: rgba(11, 17, 34, 0.7);
    border: 1px solid #28314e;
    border-radius: 12px;
    padding: 12px;
    font-size: 13px;
    color: #cdd2e2;
  }
  .rank-panel h4 {
    margin: 0 0 6px;
    font-size: 14px;
    font-weight: 700;
  }
  .rank-panel p {
    margin: 0 0 8px;
    color: #9aa2ba;
  }
  .rank-panel ul {
    padding-left: 18px;
    margin: 0;
  }
  .rank-panel li {
    margin-bottom: 4px;
  }
  .progress-card {
    background: #0b1122;
    border: 1px solid #28314e;
    border-radius: 12px;
    padding: 12px;
  }
  .progress-card h4 {
    margin: 0 0 6px;
    font-size: 13px;
    color: #9aa2ba;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }
  .progress-card .value {
    font-size: 18px;
    font-weight: 700;
    color: #f0c061;
  }
  .challenge-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 13px;
    color: #cdd2e2;
  }
  .challenge-bar {
    height: 8px;
    background: #1f2a49;
    border-radius: 999px;
    overflow: hidden;
    margin-top: 6px;
  }
  .challenge-bar span {
    display: block;
    height: 100%;
    background: #2d8f5c;
  }
  .event-card {
    background: #0b1122;
    border: 1px solid #28314e;
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
  }
  .event-card.halloween {
    border-color: rgba(255, 140, 0, 0.6);
    box-shadow: 0 0 18px rgba(160, 84, 255, 0.2);
    background: linear-gradient(135deg, rgba(26, 12, 45, 0.9), rgba(11, 17, 34, 0.9));
  }
  .event-card.winter {
    border-color: rgba(255, 205, 120, 0.6);
    box-shadow: 0 0 18px rgba(255, 215, 130, 0.2);
    background: linear-gradient(135deg, rgba(44, 17, 17, 0.9), rgba(11, 17, 34, 0.9));
  }
  .event-card.newyear {
    border-color: rgba(240, 192, 97, 0.7);
    box-shadow: 0 0 20px rgba(240, 192, 97, 0.25);
    background: linear-gradient(135deg, rgba(12, 12, 18, 0.95), rgba(11, 17, 34, 0.9));
  }
  .event-card.halloween h4 {
    color: #f38b2e;
  }
  .event-card.winter h4 {
    color: #f6c453;
  }
  .event-card.newyear h4 {
    color: #f0c061;
  }
  .event-card h4 {
    margin: 0 0 6px;
    font-size: 14px;
    font-weight: 700;
  }
  .event-meta {
    font-size: 12px;
    color: #9aa2ba;
  }
  .leaderboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  .leaderboard table {
    width: 100%;
    font-size: 13px;
  }
  .leaderboard th,
  .leaderboard td {
    padding: 6px 4px;
    border-bottom: 1px solid #1f2a49;
  }
  .stats-section h2 {
    margin-top: 0;
    font-size: 18px;
    font-weight: 700;
  }
  .chart {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
    gap: 10px;
    align-items: end;
    height: 140px;
    margin-top: 14px;
  }
  .bar {
    background: #1f2a49;
    border-radius: 10px 10px 4px 4px;
    position: relative;
    height: 20px;
  }
  .bar.win { background: #2d8f5c; }
  .bar.push { background: #d8a748; }
  .bar.loss { background: #7a1111; }
  .bar span {
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #9aa2ba;
    white-space: nowrap;
  }
  .achievements {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 14px;
  }
  .achievement {
    background: #0b1122;
    border: 1px solid #28314e;
    border-radius: 12px;
    padding: 12px;
  }
  .achievement.unlocked {
    border-color: rgba(216, 167, 72, 0.7);
    box-shadow: 0 0 14px rgba(216, 167, 72, 0.2);
  }
  .achievement h3 {
    margin: 0 0 6px;
    font-size: 14px;
    font-weight: 700;
  }
  .achievement p {
    margin: 0;
    font-size: 12px;
    color: #9aa2ba;
  }
  .badge {
    display: inline-block;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    margin-top: 6px;
    background: #28314e;
    color: #cdd2e2;
  }
  .badge.unlocked {
    background: #f0c061;
    color: #111;
    font-weight: 700;
  }
</style>

<div class="stats-wrapper">
  <div class="stats-header">
    <h1 data-i18n="stats.title">Player statistics</h1>
    <a class="btn-ghost" data-i18n="ui.backTable" href="{{ url_for('blackjack') }}">Back to table</a>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.blackjackStats">Blackjack stats</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label" data-i18n="stats.total">Total games</div>
        <div class="value">{{ bj_total }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.wins">Wins</div>
        <div class="value">{{ bj_wins }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.losses">Losses</div>
        <div class="value">{{ bj_losses }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.pushes">Pushes</div>
        <div class="value">{{ bj_pushes }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.winrate">Win rate</div>
        <div class="value">{{ bj_win_rate }}%</div>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.rouletteStats">Roulette stats</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label" data-i18n="stats.total">Total games</div>
        <div class="value">{{ ru_total }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.wins">Wins</div>
        <div class="value">{{ ru_wins }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.losses">Losses</div>
        <div class="value">{{ ru_losses }}</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="stats.winrate">Win rate</div>
        <div class="value">{{ ru_win_rate }}%</div>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.progression">Progression</h2>
    <div class="progress-row">
      <div class="progress-card">
        <h4 data-i18n="stats.level">Level</h4>
        <div class="value">{{ level }}</div>
      </div>
      <div class="progress-card">
        <h4 data-i18n="stats.xp">XP</h4>
        <div class="value">{{ xp }}</div>
      </div>
      <div class="progress-card">
        <h4 data-i18n="stats.rank">Rank</h4>
        <div class="value" data-i18n="{{ rank_key }}">{{ rank_title }}</div>
      </div>
    </div>
    <button class="btn-ghost" type="button" id="rank-toggle" data-i18n="stats.showRanks">Show rank meanings</button>
    <div class="rank-panel" id="rank-panel">
      <h4 data-i18n="stats.rankInfoTitle">Rank guide</h4>
      <p data-i18n="stats.rankInfoDesc">Levels are based on XP earned from wins and total games.</p>
      <ul>
        <li data-i18n-html="stats.rankInfoBeginner"><strong>Beginner</strong> (Level 1-4)</li>
        <li data-i18n-html="stats.rankInfoIntermediate"><strong>Intermediate</strong> (Level 5-9)</li>
        <li data-i18n-html="stats.rankInfoAdvanced"><strong>Advanced</strong> (Level 10-14)</li>
        <li data-i18n-html="stats.rankInfoPro"><strong>Pro</strong> (Level 15-19)</li>
        <li data-i18n-html="stats.rankInfoHighRoller"><strong>High Roller</strong> (Level 20+)</li>
      </ul>
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.daily">Daily challenges</h2>
    {% for c in challenges %}
      {% set progress = (c.value / c.target * 100) if c.target > 0 else 0 %}
      <div class="challenge-item">
        <span data-i18n="{{ c.title_key }}">{{ c.title }}</span>
        <span>{{ c.value }}/{{ c.target }}</span>
      </div>
      <div class="challenge-bar">
        <span data-progress="{{ [progress, 100]|min }}"></span>
      </div>
    {% endfor %}
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.events">Event challenges</h2>
    {% for e in event_challenges %}
      <div class="event-card {{ e.theme }}" data-remaining="{{ e.remaining }}">
        <h4 data-i18n="{{ e.title_key }}">{{ e.title }}</h4>
        <p class="event-meta"><span data-i18n="stats.start">Start</span>: {{ e.start }} | <span data-i18n="stats.end">End</span>: {{ e.end }}</p>
        <p class="event-meta"><span data-i18n="stats.timeLeft">Time left</span>: <span class="countdown"></span></p>
        {% for challenge in e.challenges %}
          {% set progress = (challenge.value / challenge.target * 100) if challenge.target > 0 else 0 %}
          <div class="challenge-item">
            <span data-i18n="{{ challenge.desc_key }}">{{ challenge.desc }}</span>
            <span>{{ challenge.value }}/{{ challenge.target }}</span>
          </div>
          <div class="challenge-bar">
            <span data-progress="{{ [progress, 100]|min }}"></span>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div class="stats-section">
    <h2>
      <span data-i18n="stats.performance">Performance</span>
      <span class="event-meta">
        <span data-i18n="stats.lastGamesPrefix">(last</span>
        {{ chart_points|length }}
        <span data-i18n="stats.lastGamesSuffix">games)</span>
      </span>
    </h2>
    <div class="chart">
      {% for point in chart_points %}
        <div class="bar {% if point.result == 'player_win' %}win{% elif point.result == 'push' %}push{% else %}loss{% endif %}" data-height="{{ 20 + (point.value * 100) }}">
          <span>{{ point.label }}</span>
        </div>
      {% endfor %}
      {% if chart_points|length == 0 %}
        <p data-i18n="stats.noGames" style="color:#9aa2ba;">No games played yet.</p>
      {% endif %}
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.bests">Personal bests</h2>
    <div class="progress-row">
      <div class="progress-card">
        <h4 data-i18n="stats.highestBalance">Highest balance</h4>
        <div class="value">${{ "%.2f"|format(best_balance) }}</div>
      </div>
      <div class="progress-card">
        <h4 data-i18n="stats.longestStreak">Longest win streak</h4>
        <div class="value">{{ max_streak }}</div>
      </div>
      <div class="progress-card">
        <h4 data-i18n="stats.mostWins">Most wins</h4>
        <div class="value">{{ most_wins }}</div>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.achievements">Achievements</h2>
    <div class="achievements">
      {% for achievement in achievements %}
        <div class="achievement {% if achievement.unlocked %}unlocked{% endif %}">
          <h3 data-i18n="{{ achievement.title_key }}">{{ achievement.title }}</h3>
          <p data-i18n="{{ achievement.desc_key }}">{{ achievement.desc }}</p>
          <div class="badge {% if achievement.unlocked %}unlocked{% endif %}">
            {% if achievement.unlocked %}
              <span data-i18n="stats.unlocked">Unlocked</span>
            {% else %}
              <span data-i18n="stats.locked">Locked</span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="stats-section">
    <h2 data-i18n="stats.leaderboard">Leaderboard</h2>
    <div class="leaderboard">
      <div>
        <h4 data-i18n="stats.topBalance">Top balance</h4>
        <table>
          <tbody>
            {% for u in top_balance %}
              <tr><td>{{ u.username }}</td><td>${{ "%.2f"|format(u.balance) }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div>
        <h4 data-i18n="stats.topWinRate">Top win rate</h4>
        <table>
          <tbody>
            {% for u in top_win_rate %}
              <tr><td>{{ u.username }}</td><td>{{ u.win_rate }}%</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div>
        <h4 data-i18n="stats.topLevel">Top level</h4>
        <table>
          <tbody>
            {% for u in top_level %}
              <tr><td>{{ u.username }}</td><td><span data-i18n="stats.levelShort">Lv</span> {{ u.level }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
  function formatRemaining(seconds) {
    const s = Math.max(0, seconds);
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    const t = window.getTranslation || ((key, fallback) => fallback || key);
    const day = t('stats.daysShort', 'd');
    const hour = t('stats.hoursShort', 'h');
    const minute = t('stats.minutesShort', 'm');
    return `${d}${day} ${h}${hour} ${m}${minute}`;
  }

  document.querySelectorAll('.event-card').forEach((card) => {
    const countdownEl = card.querySelector('.countdown');
    let remaining = parseInt(card.getAttribute('data-remaining'), 10) || 0;
    countdownEl.textContent = formatRemaining(remaining);
    setInterval(() => {
      remaining -= 60;
      countdownEl.textContent = formatRemaining(remaining);
    }, 60000);
  });

  document.querySelectorAll('.challenge-bar span').forEach((bar) => {
    const progress = parseFloat(bar.getAttribute('data-progress')) || 0;
    bar.style.width = `${Math.min(progress, 100)}%`;
  });

  document.querySelectorAll('.chart .bar').forEach((bar) => {
    const height = parseFloat(bar.getAttribute('data-height')) || 20;
    bar.style.height = `${height}px`;
  });

  const rankToggle = document.getElementById('rank-toggle');
  const rankPanel = document.getElementById('rank-panel');
  if (rankToggle && rankPanel) {
    rankToggle.addEventListener('click', () => {
      const isOpen = rankPanel.style.display === 'block';
      rankPanel.style.display = isOpen ? 'none' : 'block';
      rankToggle.textContent = window.getTranslation(
        isOpen ? 'stats.showRanks' : 'stats.hideRanks',
        isOpen ? 'Show rank meanings' : 'Hide rank meanings'
      );
    });
  }
</script>
{% endblock %}
