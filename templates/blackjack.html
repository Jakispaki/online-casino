{% extends "base.html" %}

{% block content %}
<style>
  body {
    background: radial-gradient(circle at top, #0b1224, #05070d 55%, #030407 100%);
    color: #e8e8e8;
  }
  :root {
    --felt-color: #0b1b14;
    --felt-border: #1f3b2c;
    --card-width: 58px;
    --card-height: 78px;
  }
  .casino-wrapper {
    margin: 24px auto 60px;
    max-width: 1100px;
    padding: 0 16px;
  }
  .casino-topbar {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 12px;
    background: #0f162b;
    border: 1px solid rgba(255, 215, 130, 0.18);
    border-radius: 14px;
    padding: 12px 16px;
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
  }
  .casino-title {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.4px;
  }
  .balance-pill {
    background: #0b1122;
    border: 1px solid #28314e;
    border-radius: 999px;
    padding: 6px 16px;
    font-weight: 700;
    color: #f0c061;
  }
  .topbar-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  .icon-btn {
    background: #0b1122;
    border: 1px solid #28314e;
    color: #cdd2e2;
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 600;
  }
  .icon-btn:hover,
  .icon-btn:focus {
    border-color: #d8a748;
    color: #f0c061;
  }
  .table-area {
    margin-top: 22px;
    background: var(--felt-color);
    border: 2px solid var(--felt-border);
    border-radius: 22px;
    padding: 22px 18px 26px;
    box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
  }
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #cfe7d9;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }
  .bet-panel {
    background: rgba(11, 17, 34, 0.7);
    border: 1px solid #28314e;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 20px;
  }
  .bet-panel label {
    font-size: 13px;
    color: #cdd2e2;
    font-weight: 600;
  }
  .bet-panel .form-control {
    max-width: 180px;
    background: #0b1122;
    border: 1px solid #28314e;
    color: #f4f4f6;
    border-radius: 10px;
  }
  .btn-auth {
    background: linear-gradient(135deg, #d8a748, #b9801f);
    border: none;
    color: #111;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
  }
  .btn-auth:hover,
  .btn-auth:focus {
    background: linear-gradient(135deg, #f0c061, #c98e29);
    color: #111;
  }
  .card-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 10px 0 6px;
  }
  .hand-label {
    font-size: 14px;
    color: #cfe7d9;
    margin-bottom: 6px;
    font-weight: 600;
  }
  .card {
    width: var(--card-width);
    height: var(--card-height);
    border-radius: 10px;
    background: #f7f7fb;
    color: #121212;
    border: 2px solid #0b0f1f;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.25);
  }
  .card.red { color: #b31313; }
  .card.hidden {
    background: linear-gradient(135deg, #1c2a6b, #101738);
    border-color: #0a0f2c;
  }
  .hand-value {
    color: #f0c061;
    font-weight: 700;
  }
  .status-area {
    margin-top: 10px;
  }
  .status-badge {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 999px;
    font-weight: 700;
    background: rgba(15, 22, 43, 0.8);
    border: 1px solid #28314e;
  }
  .action-bar {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .btn-action {
    border-radius: 10px;
    padding: 10px 16px;
    font-weight: 700;
    border: none;
  }
  .btn-hit { background: #2d8f5c; color: #fff; }
  .btn-stand { background: #d8a748; color: #111; }
  .btn-again { background: #1f4aa8; color: #fff; }
  .tutorial-overlay {
    position: fixed;
    inset: 0;
    background: rgba(3, 4, 7, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  .tutorial-card {
    background: #0f162b;
    border: 1px solid rgba(255, 215, 130, 0.2);
    border-radius: 14px;
    padding: 20px;
    max-width: 420px;
    text-align: center;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
  }
  .tutorial-card h3 {
    margin-top: 0;
    font-size: 20px;
    font-weight: 700;
  }
  .tutorial-actions {
    margin-top: 16px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .tutorial-actions button {
    border-radius: 10px;
    padding: 8px 14px;
    border: none;
    font-weight: 700;
  }
  .btn-tutorial {
    background: #f0c061;
    color: #111;
  }
  .btn-skip {
    background: #0b1122;
    border: 1px solid #28314e;
    color: #cdd2e2;
  }

  @media (max-width: 768px) {
    .casino-topbar {
      grid-template-columns: 1fr;
      text-align: center;
    }
    .topbar-actions { justify-content: center; }
    .balance-pill { display: inline-block; }
  }
</style>

<div class="casino-wrapper">
  <div class="casino-topbar">
    <div class="casino-title">Royal Ace Blackjack</div>
    <div class="balance-pill">Balance: <span id="balance">${{ "%.2f"|format(balance) }}</span></div>
    <div class="topbar-actions">
      <a class="icon-btn" data-i18n="nav.settings" href="{{ url_for('settings') }}">Settings</a>
      <a class="icon-btn" data-i18n="nav.deposit" href="{{ url_for('deposit') }}">Add funds</a>
      <a class="icon-btn" data-i18n="nav.roulette" href="{{ url_for('roulette') }}">Roulette</a>
    </div>
  </div>

  <div class="table-area">
    <div class="table-header">
      <span>Blackjack table</span>
      <span>Dealer stands on 17</span>
    </div>

    <div id="bet-section" class="bet-panel">
      <label for="bet">Bet Amount ($)</label>
      <input type="number" class="form-control" id="bet" value="10" min="1" step="0.01">
      <button class="btn-auth" style="margin-top: 10px;" onclick="startGame()">Deal cards</button>
    </div>

    <div id="game-section" style="display: none;">
      <div class="hand-label">Dealer</div>
      <div id="dealer-cards" class="card-row"></div>
      <div>Value: <span class="hand-value" id="dealer-value">?</span></div>

      <hr style="border-color:#1f3b2c; margin: 16px 0;">

      <div class="hand-label">Player</div>
      <div id="player-cards" class="card-row"></div>
      <div>Value: <span class="hand-value" id="player-value">0</span></div>

      <div id="game-status" class="status-area"></div>

      <div id="action-buttons" class="action-bar">
        <button class="btn-action btn-hit" onclick="playerHit()">Hit</button>
        <button class="btn-action btn-stand" onclick="playerStand()">Stand</button>
      </div>

      <div id="play-again" style="display: none; margin-top: 16px;">
        <button class="btn-action btn-again" onclick="location.reload()">Play Again</button>
      </div>
    </div>
  </div>
</div>

<div class="tutorial-overlay" id="tutorial-overlay">
  <div class="tutorial-card">
    <h3>Welcome to Blackjack</h3>
    <p id="tutorial-text">Set your bet and press Deal to start.</p>
    <label style="display:block; margin-top:8px; font-size:12px; color:#9aa2ba;">
      <input type="checkbox" id="tutorial-disable"> Do not show again
    </label>
    <div class="tutorial-actions">
      <button class="btn-skip" id="tutorial-skip">Skip</button>
      <button class="btn-tutorial" id="tutorial-next">Next</button>
    </div>
  </div>
</div>

<script>
const SETTINGS_KEY = 'casino_settings';
const themeMap = {
  green: { felt: '#0b1b14', border: '#1f3b2c' },
  blue: { felt: '#0b1224', border: '#23345d' },
  red: { felt: '#241011', border: '#4e1b1f' }
};
const cardSizes = {
  standard: { w: '58px', h: '78px' },
  large: { w: '68px', h: '92px' },
  compact: { w: '50px', h: '68px' }
};

function applySettings() {
  const raw = localStorage.getItem(SETTINGS_KEY);
  if (!raw) return;
  try {
    const settings = JSON.parse(raw);
    const theme = themeMap[settings.theme] || themeMap.green;
    const size = cardSizes[settings.cardSize] || cardSizes.standard;
    document.documentElement.style.setProperty('--felt-color', theme.felt);
    document.documentElement.style.setProperty('--felt-border', theme.border);
    document.documentElement.style.setProperty('--card-width', size.w);
    document.documentElement.style.setProperty('--card-height', size.h);
  } catch {
    return;
  }
}

applySettings();

let currentSessionId = null;

function startGame() {
  const bet = parseFloat(document.getElementById('bet').value);
  
  if (isNaN(bet) || bet <= 0) {
    alert('Enter a valid bet amount');
    return;
  }

  const formData = new FormData();
  formData.append('bet', bet);

  fetch('/blackjack/new', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      currentSessionId = data.session_id;
      console.log('Game started, session_id:', currentSessionId);
      updateDisplay(data);
      document.getElementById('bet-section').style.display = 'none';
      document.getElementById('game-section').style.display = 'block';
    })
    .catch(e => {
      console.error('Error:', e);
      alert('Error starting game: ' + e);
    });
}

function playerHit() {
  if (!currentSessionId) {
    alert('No active game');
    return;
  }

  const formData = new FormData();
  formData.append('session_id', currentSessionId);

  fetch('/blackjack/hit', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      console.log('Hit response:', data);
      updateDisplay(data);
      if (data.finished) {
        document.getElementById('action-buttons').style.display = 'none';
        document.getElementById('play-again').style.display = 'block';
      }
    })
    .catch(e => console.error('Error:', e));
}

function playerStand() {
  if (!currentSessionId) {
    alert('No active game');
    return;
  }

  const formData = new FormData();
  formData.append('session_id', currentSessionId);

  fetch('/blackjack/stand', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      console.log('Stand response:', data);
      updateDisplay(data);
      document.getElementById('action-buttons').style.display = 'none';
      document.getElementById('play-again').style.display = 'block';
    })
    .catch(e => console.error('Error:', e));
}

function updateDisplay(data) {
  // Display dealer cards
  const dealerDiv = document.getElementById('dealer-cards');
  dealerDiv.innerHTML = data.dealer_hand.map((card, index) => {
    if (card === '??') return '<div class="card hidden"></div>';
    const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
    return '<div class="card' + (isRed ? ' red' : '') + '">' + card + '</div>';
  }).join('');
  document.getElementById('dealer-value').textContent = data.dealer_value;

  // Display player cards
  const playerDiv = document.getElementById('player-cards');
  playerDiv.innerHTML = data.player_hand.map(card => {
    const isRed = card.includes('‚ô•') || card.includes('‚ô¶');
    return '<div class="card' + (isRed ? ' red' : '') + '">' + card + '</div>';
  }).join('');
  document.getElementById('player-value').textContent = data.player_value;

  // Display result if finished
  if (data.finished) {
    let resultText = '';
    let resultClass = '';
    
    if (data.result === 'player_bust') {
      resultText = 'üí• BUST! Game Over!';
      resultClass = 'danger';
    } else if (data.result === 'player_win') {
      resultText = 'üéâ YOU WIN!';
      resultClass = 'success';
    } else if (data.result === 'dealer_win') {
      resultText = 'üòû Dealer Wins';
      resultClass = 'warning';
    } else if (data.result === 'push') {
      resultText = 'ü§ù Push - Tie!';
      resultClass = 'info';
    }
    
    document.getElementById('game-status').innerHTML =
      '<div class="status-badge">' + resultText + '</div>';
  }
}
</script>
<script>
  const tutorialKey = 'tutorial:blackjack';
  const tutorialSteps = [
    'Set your bet and press Deal to start.',
    'Hit to draw another card and improve your hand.',
    'Stand to end your turn and let the dealer play.',
    'Track your balance and results at the top.'
  ];
  let tutorialIndex = 0;

  const overlay = document.getElementById('tutorial-overlay');
  const text = document.getElementById('tutorial-text');
  const nextBtn = document.getElementById('tutorial-next');
  const skipBtn = document.getElementById('tutorial-skip');
  const disableBox = document.getElementById('tutorial-disable');

  function showTutorial() {
    text.textContent = tutorialSteps[tutorialIndex];
    overlay.style.display = 'flex';
  }

  function closeTutorial() {
    overlay.style.display = 'none';
    if (disableBox.checked) {
      localStorage.setItem(tutorialKey, 'disabled');
    }
  }

  if (localStorage.getItem(tutorialKey) !== 'disabled') {
    showTutorial();
  }

  nextBtn.addEventListener('click', () => {
    tutorialIndex += 1;
    if (tutorialIndex >= tutorialSteps.length) {
      closeTutorial();
    } else {
      text.textContent = tutorialSteps[tutorialIndex];
    }
  });

  skipBtn.addEventListener('click', closeTutorial);
</script>
{% endblock %}
